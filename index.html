<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cryptoquote</title>
  </head>

  <body>
    <main id="main">
      <h1>Cryptoquote</h1>
      <textarea id="ciphertext-input"></textarea>
      <p id="ciphertext"></p>
      <p id="plaintext"></p>
      <p id="ciphertext-char-tally"></p>
    </main>
  </body>

  <style>
    html {
      font-family: 'Courier New', Courier, monospace;
    }
    #main {
      width: 50%;
      margin: auto;
    }
    #ciphertext-input {
      width: 100%;
      height: 100px;
    }
    .highlight {
      background-color: yellow;
    }
    span.letter {
      margin-right: 0.2rem;
    }
  </style>

  <script>
    const ciphertextInputElement = document.querySelector('#ciphertext-input');
    const ciphertextElement = document.querySelector('#ciphertext');
    const plaintextElement = document.querySelector('#plaintext');
    const ciphertextCharTallyElement = document.querySelector(
      '#ciphertext-char-tally'
    );
    let selectedLetter;
    const translationMap = {};

    ciphertextInputElement.addEventListener('input', setupGame);

    function setupGame() {
      const ciphertext = ciphertextInputElement.value.toUpperCase();
      ciphertextElement.innerHTML = ciphertext.replace(
        /\w/g,
        (letter) =>
          `<span class='letter' data-ciphertext-char=${letter}>${letter}</span>`
      );
      plaintextElement.innerHTML = ciphertext.replace(
        /\w/g,
        (letter) =>
          `<span class='letter' data-ciphertext-char=${letter}>_</span>`
      );

      const ciphertextCharTally = {};
      ciphertext
        .split('')
        .forEach((letter) =>
          ciphertextCharTally[letter]
            ? (ciphertextCharTally[letter] += 1)
            : (ciphertextCharTally[letter] = 1)
        );
      ciphertextCharTallyElement.innerHTML = Object.entries(ciphertextCharTally)
        .sort(([_char1, tally1], [_char2, tally2]) => tally2 - tally1)
        .map(([char, tally]) => `${char}: ${tally}`)
        .join('<br>');

      const allLetterElements = document.querySelectorAll('.letter');
      allLetterElements.forEach((letterElement) => {
        letterElement.addEventListener('click', () => {
          allLetterElements.forEach((letterElement) =>
            letterElement.classList.remove('highlight')
          );
          selectedLetter = letterElement.getAttribute('data-ciphertext-char');
          const selectedLetterElements = document.querySelectorAll(
            `.letter[data-ciphertext-char=${selectedLetter}`
          );
          selectedLetterElements.forEach((selectedLetterElement) =>
            selectedLetterElement.classList.add('highlight')
          );
        });
      });
    }

    document.addEventListener('keyup', (event) => {
      if (!selectedLetter) return;
      const enteredLetter = event.key.toUpperCase();
      if (!enteredLetter.match(/^[A-Z]$/)) return;

      Object.keys(translationMap).forEach((ciphertextLetter) => {
        if (translationMap[ciphertextLetter] === enteredLetter) {
          delete translationMap[ciphertextLetter];
        }
      });
      translationMap[selectedLetter] = enteredLetter;
      document
        .querySelectorAll('p#plaintext .letter')
        .forEach((plaintextLetterElement) => {
          plaintextLetterElement.innerHTML =
            translationMap[
              plaintextLetterElement.getAttribute('data-ciphertext-char')
            ] || '_';
        });

      document
        .querySelectorAll('.letter')
        .forEach((letterElement) =>
          letterElement.classList.remove('highlight')
        );
    });
  </script>
</html>
