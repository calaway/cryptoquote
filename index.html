<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cryptoquote</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“œ</text></svg>"
    />
  </head>

  <body>
    <main id="main">
      <h1>Cryptoquote</h1>
      <hr />

      <section>
        <hgroup>
          <h4>Enter ciphertext</h4>
          <button class="hide-button">Hide</button>
        </hgroup>
        <div class="hideable">
          <textarea
            id="ciphertext-input"
            placeholder="Enter Cryptoquote text"
          ></textarea>
          <button id="reset">Reset</button>
        </div>
      </section>
      <hr />

      <section>
        <h4>Ciphertext</h4>
        <p id="ciphertext"></p>
      </section>
      <hr />

      <section>
        <h4>Plaintext</h4>
        <p id="plaintext"></p>
        <button id="clear">Clear</button>
      </section>
      <hr />

      <section>
        <hgroup>
          <h4>Hint: Character tally</h4>
          <button class="hide-button">Show</button>
        </hgroup>
        <div class="hideable" hidden>
          <p id="ciphertext-char-tally"></p>
        </div>
      </section>
    </main>
  </body>

  <style>
    html {
      font-family: 'Courier New', Courier, monospace;
      font-size: larger;
      background-image: url(./images/background.jpg);
      background-size: cover;
    }
    #main {
      max-width: 500px;
      margin: auto;
    }
    hgroup {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #ciphertext-input {
      width: 100%;
      height: 100px;
    }
    .highlight {
      background-color: yellow;
    }
    span.char {
      margin-right: 0.2rem;
    }
  </style>

  <script>
    const ciphertextInputElement = document.querySelector('#ciphertext-input');
    const ciphertextElement = document.querySelector('#ciphertext');
    const plaintextElement = document.querySelector('#plaintext');
    const ciphertextCharTallyElement = document.querySelector(
      '#ciphertext-char-tally'
    );
    let selectedChar;
    let translationMap = {};

    function renderCiphertextInput() {
      ciphertextInputElement.value = localStorage.ciphertext;
    }

    function renderCiphertext() {
      ciphertextElement.innerHTML = localStorage.ciphertext
        .replace(
          /\w/g,
          (char) =>
            `<span class='char' data-ciphertext-char=${char}>${char}</span>`
        )
        .replace(/\n/g, '<br />');
    }

    function renderPlaintext() {
      plaintextElement.innerHTML = localStorage.ciphertext
        .replace(
          /\w/g,
          (char) => `<span class='char' data-ciphertext-char=${char}>_</span>`
        )
        .replace(/\n/g, '<br />');
    }

    function addClickListeners() {
      const allCharElements = document.querySelectorAll('.char');
      allCharElements.forEach((charElement) => {
        charElement.addEventListener('click', () => {
          allCharElements.forEach((charElement) =>
            charElement.classList.remove('highlight')
          );
          selectedChar = charElement.getAttribute('data-ciphertext-char');
          const selectedCharElements = document.querySelectorAll(
            `.char[data-ciphertext-char=${selectedChar}`
          );
          selectedCharElements.forEach((selectedCharElement) =>
            selectedCharElement.classList.add('highlight')
          );
        });
      });
    }

    function renderCharTally() {
      const ciphertextCharTally = {};
      localStorage.ciphertext
        .split('')
        .forEach((char) =>
          ciphertextCharTally[char]
            ? (ciphertextCharTally[char] += 1)
            : (ciphertextCharTally[char] = 1)
        );
      ciphertextCharTallyElement.innerHTML = Object.entries(ciphertextCharTally)
        .sort(([_char1, tally1], [_char2, tally2]) => tally2 - tally1)
        .map(([char, tally]) => `${char}: ${tally}`)
        .join('<br />');
    }

    function load() {
      localStorage.ciphertext = localStorage.ciphertext || '';
      renderCiphertextInput();
      renderCiphertext();
      renderPlaintext();
      addClickListeners();
      renderCharTally();
    }

    load();

    ciphertextInputElement.addEventListener('input', (event) => {
      localStorage.ciphertext = event.target.value.toUpperCase();
      renderCiphertextInput();
      renderCiphertext();
      renderPlaintext();
      addClickListeners();
      renderCharTally();
    });

    function unselectChar() {
      document
        .querySelectorAll('.char')
        .forEach((charElement) => charElement.classList.remove('highlight'));

      selectedChar = null;
    }

    function handleKeyStroke() {
      if (!selectedChar) return;

      const enteredChar = event.key.toUpperCase();

      if (enteredChar === 'ESCAPE') {
        unselectChar();
        return;
      }

      if (!enteredChar.match(/^[A-Z]$/) && !enteredChar === 'BACKSPACE') return;

      Object.entries(translationMap).forEach(
        ([ciphertextChar, plaintextChar]) => {
          if (plaintextChar === enteredChar) {
            delete translationMap[ciphertextChar];
          }
        }
      );

      if (enteredChar === 'BACKSPACE') {
        delete translationMap[selectedChar];
      } else {
        translationMap[selectedChar] = enteredChar;
      }
      document
        .querySelectorAll('p#plaintext .char')
        .forEach((plaintextCharElement) => {
          plaintextCharElement.innerHTML =
            translationMap[
              plaintextCharElement.getAttribute('data-ciphertext-char')
            ] || '_';
        });

      unselectChar();
    }

    document.addEventListener('keyup', handleKeyStroke);

    function toggleHideNextElement(event) {
      const hideableElement = event.target.parentElement.parentElement.querySelector(
        '.hideable'
      );
      hideableElement.toggleAttribute('hidden');
      if (hideableElement.hidden) {
        event.target.innerHTML = 'Show';
      } else {
        event.target.innerHTML = 'Hide';
      }
    }

    document
      .querySelectorAll('.hide-button')
      .forEach((hideButton) =>
        hideButton.addEventListener('click', toggleHideNextElement)
      );

    function reset() {
      localStorage.clear();
      load();
    }

    document.querySelector('#reset').addEventListener('click', reset);

    function clear() {
      translationMap = {};
      load();
    }

    document.querySelector('#clear').addEventListener('click', clear);
  </script>
</html>
